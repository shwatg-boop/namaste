<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Namaste Shoutouts — Firebase MVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel for quick demo -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (ES Modules via <script type=module>) -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, addDoc, getDocs, updateDoc,
    collection, query, where, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAwRXJkjgf8zTyzx1gtQrY-lkWERRmagi8",
    authDomain: "namaste-14425.firebaseapp.com",
    projectId: "namaste-14425",
    storageBucket: "namaste-14425.firebasestorage.app",
    messagingSenderId: "217856135534",
    appId: "1:217856135534:web:53ae85886c555e0134317f",
    measurementId: "G-EL1K3LTZMY"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- API used by the React app ---
  async function fbSignUp(email, password, role, name) {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;
    await setDoc(doc(db, "profiles", uid), {
      role, name, handle: null, bio: "", city: "",
      categories: [], platforms: ["instagram","tiktok","youtube"],
      rates: { video: 2000, socialPost: 5000, liveCall: 3000 },
      socialAddOn: { instagram: 3000, tiktok: 2000, youtube: 4000 },
      minLeadDays: 2, avatarUrl: "", createdAt: serverTimestamp()
    });
    return uid;
  }
  function fbSignIn(email, password) { return signInWithEmailAndPassword(auth, email, password); }
  function fbOnAuth(fn) { return onAuthStateChanged(auth, fn); }
  function fbSignOut() { return signOut(auth); }

  // Resilient list with fallbacks + placeholders
  async function fbListInfluencers() {
    try {
      const q1 = query(
        collection(db, "profiles"),
        where("role","==","influencer"),
        orderBy("name")
      );
      const snap1 = await getDocs(q1);
      const real1 = snap1.docs.map(d => ({ id: d.id, ...d.data() }));
      return real1.length ? real1 : (window.PLACEHOLDER_INFLUENCERS || []);
    } catch (err) {
      console.warn("fbListInfluencers fallback A (orderBy failed):", err?.message || err);
      try {
        const q2 = query(collection(db, "profiles"), where("role","==","influencer"));
        const snap2 = await getDocs(q2);
        const real2 = snap2.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        return real2.length ? real2 : (window.PLACEHOLDER_INFLUENCERS || []);
      } catch (err2) {
        console.warn("fbListInfluencers fallback B (full scan):", err2?.message || err2);
        const snap3 = await getDocs(collection(db, "profiles"));
        const all = snap3.docs.map(d => ({ id: d.id, ...d.data() }));
        const real3 = all.filter(x=>x.role==="influencer")
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        return real3.length ? real3 : (window.PLACEHOLDER_INFLUENCERS || []);
      }
    }
  }

  async function fbMyOrdersClient(uid) {
    const q = query(collection(db, "orders"), where("clientId","==",uid), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  async function fbMyOrdersInfluencer(uid) {
    const q = query(collection(db, "orders"), where("influencerId","==",uid), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  async function fbCreateOrder(order) {
    const ref = await addDoc(collection(db, "orders"), { ...order, createdAt: serverTimestamp() });
    const docSnap = await getDoc(ref);
    return { id: ref.id, ...docSnap.data() };
  }
  async function fbSetOrderStatus(orderId, status) {
    await updateDoc(doc(db, "orders", orderId), { status });
  }
  async function fbGetProfile(uid) {
    const d = await getDoc(doc(db, "profiles", uid));
    return d.exists() ? { id: d.id, ...d.data() } : null;
  }
  async function fbUpdateProfile(uid, patch) {
    await updateDoc(doc(db, "profiles", uid), patch);
  }

  window.FirebaseAPI = {
    auth, db,
    signUp: fbSignUp,
    signIn: fbSignIn,
    onAuth: fbOnAuth,
    signOut: fbSignOut,
    listInfluencers: fbListInfluencers,
    myOrdersClient: fbMyOrdersClient,
    myOrdersInfluencer: fbMyOrdersInfluencer,
    createOrder: fbCreateOrder,
    setOrderStatus: fbSetOrderStatus,
    getProfile: fbGetProfile,
    updateProfile: fbUpdateProfile
  };

  // --- Client-side placeholder influencers (used only if DB has none) ---
  window.PLACEHOLDER_INFLUENCERS = [
    {
      id: "ph-1",
      _placeholder: true,
      name: "Sushila Rai",
      handle: "@sushila.rai",
      bio: "Singer • Birthday songs & pep talks",
      city: "Kathmandu",
      categories: ["Singer", "Entertainment"],
      platforms: ["instagram", "tiktok"],
      rates: { video: 2500, socialPost: 7000, liveCall: 3000 },
      socialAddOn: { instagram: 4000, tiktok: 3000, youtube: 0 },
      minLeadDays: 2
    },
    {
      id: "ph-2",
      _placeholder: true,
      name: "Bikram Thapa",
      handle: "@bikram.thapa",
      bio: "Comedian • Light roasts & shoutouts",
      city: "Lalitpur",
      categories: ["Comedian"],
      platforms: ["instagram", "youtube"],
      rates: { video: 3000, socialPost: 9000, liveCall: 4000 },
      socialAddOn: { instagram: 5000, tiktok: 0, youtube: 8000 },
      minLeadDays: 3
    },
    {
      id: "ph-3",
      _placeholder: true,
      name: "Anjana Gurung",
      handle: "@anjana.g",
      bio: "Dancer • Congrats & motivation",
      city: "Bhaktapur",
      categories: ["Dance", "Fitness"],
      platforms: ["instagram", "tiktok"],
      rates: { video: 2200, socialPost: 6500, liveCall: 2800 },
      socialAddOn: { instagram: 3500, tiktok: 2500, youtube: 0 },
      minLeadDays: 2
    },
    {
      id: "ph-4",
      _placeholder: true,
      name: "Prakash Karki",
      handle: "@prakash.k",
      bio: "Actor • Birthday skits & wishes",
      city: "Pokhara",
      categories: ["Actor"],
      platforms: ["instagram", "youtube"],
      rates: { video: 4000, socialPost: 11000, liveCall: 5500 },
      socialAddOn: { instagram: 6000, tiktok: 0, youtube: 9000 },
      minLeadDays: 3
    }
  ];
</script>

</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const {useEffect, useMemo, useState} = React;
    const fb = window.FirebaseAPI;

    function Badge({ children }) { return <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium">{children}</span>; }
    function Card({ children, className = "" }) { return <div className={"rounded-2xl shadow-sm border bg-white p-4 " + className}>{children}</div>; }
    function Money({ v }) { const nf = React.useMemo(() => new Intl.NumberFormat("en-NP"), []); return <span>रु {nf.format(v||0)}</span>; }

    function App() {
      const [user, setUser] = useState(null);       // Firebase user
      const [profile, setProfile] = useState(null); // profiles/{uid}
      const [tab, setTab] = useState("home");

      useEffect(() => {
        return fb.onAuth(async u => {
          setUser(u);
          if (u) setProfile(await fb.getProfile(u.uid));
          else setProfile(null);
        });
      }, []);

      const role = profile?.role;

      return (
        <div className="min-h-screen bg-gray-50">
          <header className="sticky top-0 z-40 backdrop-blur bg-white/80 border-b">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-2"><span className="text-xl font-bold">Namaste Shoutouts</span><Badge>Firebase</Badge></div>
              <div className="flex items-center gap-3">
                <button onClick={()=>setTab("home")} className={"text-sm " + (tab==='home'?'font-semibold':'')}>Home</button>
                <button onClick={()=>setTab("explore")} className={"text-sm " + (tab==='explore'?'font-semibold':'')}>Explore</button>
                {user && role==='influencer' && <button onClick={()=>setTab("influencer")} className={"text-sm " + (tab==='influencer'?'font-semibold':'')}>My Dashboard</button>}
                {user && role==='client' && <button onClick={()=>setTab("client")} className={"text-sm " + (tab==='client'?'font-semibold':'')}>My Dashboard</button>}
                {!user ? <button onClick={()=>setTab("auth")} className={"text-sm " + (tab==='auth'?'font-semibold':'')}>Login / Sign up</button> :
                  <div className="flex items-center gap-2">
                    <Badge>{role||"user"}</Badge><span className="text-sm">{profile?.name||user.email}</span>
                    <button onClick={()=>fb.signOut()} className="text-sm underline">Logout</button>
                  </div>}
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 grid gap-6">
            {tab==="home" && <Home setTab={setTab} />}
            {tab==="auth" && <AuthPanel onAuthed={()=>setTab("explore")} />}
            {tab==="explore" && (user && role==='client' ? <ClientDashboard me={user} /> : <ExploreLoggedOut />)}
            {tab==="influencer" && user && role==='influencer' && <InfluencerDashboard me={user} profile={profile} setProfile={setProfile} />}
            {tab==="client" && user && role==='client' && <ClientDashboard me={user} />}
          </main>

          <footer className="max-w-6xl mx-auto px-4 py-8 text-xs text-gray-500">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <span>© {(new Date()).getFullYear()} Namaste Shoutouts (Firebase MVP)</span>
            </div>
          </footer>
        </div>
      );
    }

    function Home({ setTab }) {
      return (
        <div className="grid lg:grid-cols-2 gap-4 items-center">
          <div className="space-y-4">
            <h1 className="text-3xl font-bold">Book personalised video shoutouts, social posts, or live calls from Nepali stars</h1>
            <p className="text-gray-600">Firebase-backed MVP: email/password auth, Firestore data, simple orders.</p>
            <div className="flex gap-2">
              <button onClick={()=>setTab("explore")} className="rounded-2xl bg-black text-white px-4 py-2">Explore influencers</button>
              <button onClick={()=>setTab("auth")} className="rounded-2xl border px-4 py-2">Login / Sign up</button>
            </div>
          </div>
          <Card>
            <h3 className="text-lg font-semibold mb-3">How it works</h3>
            <ol className="text-sm grid gap-2 list-decimal ml-4">
              <li>Sign up as <strong>Client</strong> or <strong>Influencer</strong></li>
              <li>Influencers set profile & rates</li>
              <li>Clients submit request (video / social / call)</li>
              <li>Influencer accepts/declines and delivers (status only)</li>
            </ol>
          </Card>
        </div>
      );
    }

    function AuthPanel({ onAuthed }) {
      const [mode, setMode] = useState("login");
      const [role, setRole] = useState("client");
      const [form, setForm] = useState({ name: "", email: "", password: "" });
      const [loading, setLoading] = useState(false);

      const submit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
          if (mode==="signup") {
            await fb.signUp(form.email, form.password, role, form.name);
          } else {
            await fb.signIn(form.email, form.password);
          }
          onAuthed && onAuthed();
        } catch (e) {
          alert(e.message);
        } finally { setLoading(false); }
      };

      return (
        <Card className="max-w-xl w-full">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-xl font-semibold">{mode === "login" ? "Login" : "Create account"}</h2>
            <div className="flex gap-2 bg-gray-100 rounded-full p-1 w-fit">
              <button onClick={()=>setMode("login")} className={"px-4 py-1.5 rounded-full text-sm " + (mode==="login"?"bg-white shadow border":"text-gray-600")}>Login</button>
              <button onClick={()=>setMode("signup")} className={"px-4 py-1.5 rounded-full text-sm " + (mode==="signup"?"bg-white shadow border":"text-gray-600")}>Sign up</button>
            </div>
          </div>
          {mode === "signup" && (
            <div className="mb-3">
              <div className="flex gap-2 bg-gray-100 rounded-full p-1 w-fit">
                <button onClick={()=>setRole("client")} className={"px-4 py-1.5 rounded-full text-sm " + (role==="client"?"bg-white shadow border":"text-gray-600")}>Client</button>
                <button onClick={()=>setRole("influencer")} className={"px-4 py-1.5 rounded-full text-sm " + (role==="influencer"?"bg-white shadow border":"text-gray-600")}>Influencer/Celebrity</button>
              </div>
            </div>
          )}
          <form onSubmit={submit} className="grid gap-3">
            {mode==="signup" && (
              <div className="grid gap-1">
                <label className="text-sm">Full name*</label>
                <input className="border rounded-xl p-2" value={form.name} onChange={(e)=>setForm({...form, name:e.target.value})} />
              </div>
            )}
            <div className="grid gap-1">
              <label className="text-sm">Email*</label>
              <input className="border rounded-xl p-2" type="email" value={form.email} onChange={(e)=>setForm({...form, email:e.target.value})} />
            </div>
            <div className="grid gap-1">
              <label className="text-sm">Password*</label>
              <input className="border rounded-xl p-2" type="password" value={form.password} onChange={(e)=>setForm({...form, password:e.target.value})} />
            </div>
            <button disabled={loading} className="mt-2 rounded-2xl bg-black text-white px-4 py-2">{loading ? "Please wait…" : (mode === "login" ? "Login" : "Create account")}</button>
          </form>
        </Card>
      );
    }

    function ClientDashboard({ me }) {
      const [influencers, setInfluencers] = useState([]);
      const [query, setQuery] = useState("");
      const [category, setCategory] = useState("all");
      const [myOrders, setMyOrders] = useState([]);

      useEffect(() => { fb.listInfluencers().then(setInfluencers); }, []);
      useEffect(() => { fb.myOrdersClient(me.uid).then(setMyOrders); }, [me.uid]);

      const filtered = influencers.filter((u) => {
        const matchText = (u.name + " " + (u.handle||"") + " " + (u.bio || "") + " " + (u.categories||[]).join(" ")).toLowerCase();
        const passQuery = matchText.includes(query.toLowerCase());
        const passCat = category === "all" || (u.categories||[]).map(c=>c.toLowerCase()).includes(category);
        return passQuery && passCat;
      });

      return (
        <div className="grid lg:grid-cols-3 gap-4">
          <Card className="lg:col-span-2">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
              <h3 className="text-lg font-semibold">Browse influencers</h3>
              <div className="flex gap-2">
                <input placeholder="Search name, handle, bio..." className="border rounded-2xl px-3 py-2 w-full sm:w-72" value={query} onChange={(e)=>setQuery(e.target.value)} />
                <select className="border rounded-2xl px-3 py-2" value={category} onChange={(e)=>setCategory(e.target.value)}>
                  <option value="all">All categories</option>
                  {[...new Set(influencers.flatMap((i)=>i.categories||[]))].map((c)=> (
                    <option key={c} value={String(c).toLowerCase()}>{c}</option>
                  ))}
                </select>
              </div>
            </div>
            <div className="grid md:grid-cols-2 gap-4">
              {filtered.map((u) => (<InfluencerCard key={u.id} u={u} clientId={me.uid} refreshOrders={()=>fb.myOrdersClient(me.uid).then(setMyOrders)} />))}
              {filtered.length === 0 && <p className="text-sm text-gray-500">No matches.</p>}
            </div>
          </Card>

          <Card>
            <h3 className="text-lg font-semibold mb-3">My Orders</h3>
            <div className="grid gap-3">
              {myOrders.map((o)=> (
                <div key={o.id} className="border rounded-xl p-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm">#{o.id.slice(0,6)} • <Badge>{o.status}</Badge></div>
                    <div className="text-sm font-medium"><Money v={o.price} /></div>
                  </div>
                  <div className="mt-1 text-sm">{o.delivery}</div>
                </div>
              ))}
              {myOrders.length===0 && <p className="text-sm text-gray-500">You have no orders yet.</p>}
            </div>
          </Card>
        </div>
      );
    }

    function InfluencerDashboard({ me, profile, setProfile }) {
      const [orders, setOrders] = useState([]);
      const [local, setLocal] = useState(profile||{});

      useEffect(()=>{ setLocal(profile||{}); }, [profile?.id]);
      useEffect(()=>{ fb.myOrdersInfluencer(me.uid).then(setOrders); }, [me.uid]);

      const saveProfile = async () => {
        try {
          await fb.updateProfile(me.uid, {
            name: local.name, handle: local.handle, bio: local.bio, city: local.city,
            categories: local.categories||[], platforms: local.platforms||["instagram","tiktok","youtube"],
            rates: local.rates||{ video:0, socialPost:0, liveCall:0 },
            socialAddOn: local.socialAddOn||{}, minLeadDays: Number(local.minLeadDays||2)
          });
          const p = await fb.getProfile(me.uid);
          setProfile(p);
          alert("Profile updated");
        } catch(e) { alert(e.message); }
      };

      const setOrderStatus = async (id, status) => {
        await fb.setOrderStatus(id, status);
        setOrders(await fb.myOrdersInfluencer(me.uid));
      };

      return (
        <div className="grid lg:grid-cols-3 gap-4">
          <Card className="lg:col-span-2">
            <h3 className="text-lg font-semibold mb-3">Profile & Rates</h3>
            <div className="grid sm:grid-cols-2 gap-3">
              <Input label="Display name" value={local.name||""} onChange={v=>setLocal({...local, name:v})} />
              <Input label="Handle" value={local.handle||""} onChange={v=>setLocal({...local, handle:v})} />
              <Textarea className="sm:col-span-2" label="Bio" value={local.bio||""} onChange={v=>setLocal({...local, bio:v})} />
              <Input label="City" value={local.city||""} onChange={v=>setLocal({...local, city:v})} />
              <Input label="Categories (comma separated)" value={(local.categories||[]).join(", ")} onChange={v=>setLocal({...local, categories:v.split(",").map(s=>s.trim()).filter(Boolean)})} />
              <div className="grid grid-cols-3 gap-3 sm:col-span-2">
                <NumberInput label="Video rate" value={local.rates?.video||0} onChange={v=>setLocal({...local, rates:{...local.rates, video:Number(v)}})} />
                <NumberInput label="Social post" value={local.rates?.socialPost||0} onChange={v=>setLocal({...local, rates:{...local.rates, socialPost:Number(v)}})} />
                <NumberInput label="Live call" value={local.rates?.liveCall||0} onChange={v=>setLocal({...local, rates:{...local.rates, liveCall:Number(v)}})} />
              </div>
              <div className="grid sm:grid-cols-3 gap-3 sm:col-span-2">
                <NumberInput label="Add‑on: Instagram post" value={local.socialAddOn?.instagram||0} onChange={v=>setLocal({...local, socialAddOn:{...local.socialAddOn, instagram:Number(v)}})} />
                <NumberInput label="Add‑on: TikTok video" value={local.socialAddOn?.tiktok||0} onChange={v=>setLocal({...local, socialAddOn:{...local.socialAddOn, tiktok:Number(v)}})} />
                <NumberInput label="Add‑on: YouTube mention" value={local.socialAddOn?.youtube||0} onChange={v=>setLocal({...local, socialAddOn:{...local.socialAddOn, youtube:Number(v)}})} />
              </div>
              <NumberInput label="Minimum lead time (days)" value={local.minLeadDays||2} onChange={v=>setLocal({...local, minLeadDays:Number(v)})} />
            </div>
            <div className="mt-3 flex gap-2">
              <button onClick={saveProfile} className="rounded-2xl bg-black text-white px-4 py-2">Save</button>
            </div>
          </Card>

          <Card>
            <h3 className="text-lg font-semibold mb-3">Requests</h3>
            <div className="grid gap-3">
              {orders.length === 0 && <p className="text-sm text-gray-500">No requests yet.</p>}
              {orders.map((o)=> (
                <div key={o.id} className="border rounded-xl p-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm">#{o.id.slice(0,6)} • <Badge>{o.status}</Badge></div>
                    <div className="text-sm font-medium"><Money v={o.price} /></div>
                  </div>
                  <div className="mt-2 text-sm">
                    <div>Delivery: {o.delivery === 'video' ? 'Video shoutout' : o.delivery === 'social' ? `Social post (${o.selectedPlatform})` : `Live call (${o.callDuration} min)`}</div>
                    {o.addOnPost && <div>Add‑on: Post to my social</div>}
                    <div>Recipient: {o.recipientName} • Occasion: {o.occasion}</div>
                  </div>
                  <div className="mt-2 flex gap-2">
                    {o.status === "pending" && (<>
                      <button onClick={()=>setOrderStatus(o.id,"accepted")} className="rounded-xl bg-green-600 text-white px-3 py-1 text-sm">Accept</button>
                      <button onClick={()=>setOrderStatus(o.id,"declined")} className="rounded-xl bg-red-600 text-white px-3 py-1 text-sm">Decline</button>
                    </>)}
                    {o.status === "accepted" && (
                      <button onClick={()=>setOrderStatus(o.id,"delivered")} className="rounded-xl bg-blue-600 text-white px-3 py-1 text-sm">Mark Delivered</button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </Card>
        </div>
      );
    }

   function InfluencerCard({ u, clientId, refreshOrders }) {
  const [open, setOpen] = useState(false);
  const isPlaceholder = !!u._placeholder;

  return (
    <div className="border rounded-2xl overflow-hidden">
      <div className="p-4 flex gap-3">
        <div className="w-16 h-16 rounded-xl bg-gray-200"></div>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <div className="font-semibold">{u.name}</div>
            <Badge>{u.handle || "@handle"}</Badge>
          </div>
          <div className="text-sm text-gray-600">{u.bio}</div>
          <div className="mt-1 flex flex-wrap gap-1">{(u.categories||[]).map((c)=> <Badge key={c}>{c}</Badge>)}</div>
        </div>
      </div>
      <div className="border-t p-3 grid gap-2 text-sm">
        <div className="flex items-center justify-between"><span>Video shoutout</span><span className="font-medium"><Money v={u.rates?.video||0} /></span></div>
        <div className="flex items-center justify-between"><span>Social media post</span><span className="font-medium"><Money v={u.rates?.socialPost||0} /></span></div>
        <div className="flex items-center justify-between"><span>Live call</span><span className="font-medium"><Money v={u.rates?.liveCall||0} /></span></div>
        <button
          onClick={() => !isPlaceholder && setOpen(true)}
          disabled={isPlaceholder}
          title={isPlaceholder ? "Demo profile — sign up a real influencer to request" : "Request"}
          className={`mt-2 rounded-xl px-4 py-2 text-sm ${
            isPlaceholder ? "bg-gray-300 text-gray-600 cursor-not-allowed" : "bg-black text-white"
          }`}
        >
          {isPlaceholder ? "Demo profile" : "Request"}
        </button>
      </div>
      {open && (
        <RequestModal
          u={u}
          clientId={clientId}
          onClose={() => { setOpen(false); refreshOrders && refreshOrders(); }}
        />
      )}
    </div>
  );
}


    function RequestModal({ u, clientId, onClose }) {
      const [delivery, setDelivery] = useState("video");
      const [selectedPlatform, setSelectedPlatform] = useState((u.platforms||["instagram","tiktok","youtube"])[0]);
      const [callDuration, setCallDuration] = useState(10);
      const [addOnPost, setAddOnPost] = useState(false);
      const [occasion, setOccasion] = useState("");
      const [recipientName, setRecipientName] = useState("");
      const [instructions, setInstructions] = useState("");
      const [leadDays, setLeadDays] = useState(u.minLeadDays || 2);

      const basePrice = React.useMemo(() => {
        if (delivery === "video") return u.rates?.video || 0;
        if (delivery === "social") return u.rates?.socialPost || 0;
        if (delivery === "call") return u.rates?.liveCall || 0;
        return 0;
      }, [delivery, u]);

      const addOnPrice = React.useMemo(() => {
        if (!addOnPost) return 0;
        const map = u.socialAddOn || {};
        return map[selectedPlatform] || 0;
      }, [addOnPost, selectedPlatform, u]);

      const total = basePrice + addOnPrice;

      const createOrder = async () => {
        if (!recipientName) return alert("Recipient name is required.");
        const due = new Date(); due.setDate(due.getDate() + Number(leadDays || 2));
        await fb.createOrder({
          clientId, influencerId: u.id, status: "pending",
          occasion, recipientName, instructions,
          delivery: delivery === "video" ? "video" : delivery === "social" ? "social" : "call",
          selectedPlatform: delivery === "social" ? selectedPlatform : null,
          callDuration: delivery === "call" ? Number(callDuration) : null,
          addOnPost: Boolean(addOnPost && delivery !== "call"),
          price: total, dueDate: due
        });
        onClose && onClose();
        alert("Request submitted!");
      };

      return (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-xl w-full p-4">
            <div className="flex items-start justify-between">
              <div><div className="font-semibold">Request: {u.name}</div><div className="text-xs text-gray-600">Minimum lead: {u.minLeadDays || 0} days</div></div>
              <button onClick={onClose} className="text-gray-500">✕</button>
            </div>
            <div className="mt-3 grid gap-3">
              <div className="grid gap-1">
                <label className="text-sm">Delivery type</label>
                <div className="flex gap-2">
                  {[{v:"video", l:"Video shoutout"},{v:"social", l:"Social media post"},{v:"call", l:"Live call"}].map((opt)=> (
                    <button key={opt.v} onClick={()=>setDelivery(opt.v)} className={"px-3 py-1.5 rounded-full border text-sm " + (delivery===opt.v? 'bg-black text-white' : '')}>{opt.l}</button>
                  ))}
                </div>
              </div>
              {delivery === "social" && (
                <div className="grid sm:grid-cols-2 gap-3">
                  <div className="grid gap-1">
                    <label className="text-sm">Platform</label>
                    <select className="border rounded-xl px-3 py-2" value={selectedPlatform} onChange={(e)=>setSelectedPlatform(e.target.value)}>
                      {(u.platforms||["instagram","tiktok","youtube"]).map((p)=> (<option key={p} value={p}>{p}</option>))}
                    </select>
                  </div>
                  <div className="grid gap-1">
                    <label className="text-sm">Add-on: post to influencer's social?</label>
                    <select className="border rounded-xl px-3 py-2" value={addOnPost? 'yes':'no'} onChange={(e)=>setAddOnPost(e.target.value==='yes')}>
                      <option value="no">No</option><option value="yes">Yes (+ add-on rate)</option>
                    </select>
                  </div>
                </div>
              )}
              {delivery === "call" && (
                <div className="grid gap-1"><label className="text-sm">Call duration (minutes)</label>
                  <input className="border rounded-xl p-2 w-36" type="number" value={callDuration} onChange={(e)=>setCallDuration(e.target.value)} />
                </div>
              )}
              <div className="grid sm:grid-cols-2 gap-3">
                <Input label="Recipient name*" value={recipientName} onChange={setRecipientName} />
                <Input label="Occasion" value={occasion} onChange={setOccasion} />
              </div>
              <Textarea label="Instructions / script notes" value={instructions} onChange={setInstructions} />
              <NumberInput label="Lead time (days)" value={leadDays} onChange={setLeadDays} />
              <div className="border rounded-xl p-3 bg-gray-50">
                <Row label="Base price" value={<Money v={basePrice} />} />
                {delivery !== 'call' && addOnPost && <Row label={"Add‑on ("+selectedPlatform+")"} value={<Money v={addOnPrice} />} />}
                <div className="mt-2 flex items-center justify-between font-semibold"><span>Total</span><span><Money v={total} /></span></div>
              </div>
              <div className="flex items-center justify-between">
                <button onClick={onClose} className="px-4 py-2 rounded-xl border">Cancel</button>
                <button onClick={createOrder} className="px-4 py-2 rounded-xl bg-black text-white">Submit request</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ExploreLoggedOut() {
      const [influencers, setInfluencers] = useState([]);
      useEffect(() => { fb.listInfluencers().then(setInfluencers); }, []);
      return (
        <div className="grid gap-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold">Featured influencers</h3>
            <span className="text-sm text-gray-500">Login to request</span>
          </div>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            {influencers.map((u)=> (
              <div key={u.id} className="border rounded-2xl p-3">
                <div className="flex gap-3">
                  <div className="w-14 h-14 rounded-xl bg-gray-200"></div>
                  <div>
                    <div className="font-medium">{u.name}</div>
                    <div className="text-xs text-gray-600">{u.bio}</div>
                  </div>
                </div>
                <div className="mt-2 text-sm">Video <span className="font-medium"><Money v={u.rates?.video||0} /></span></div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Row({label, value}) { return (<div className="flex items-center justify-between text-sm"><span>{label}</span><span>{value}</span></div>); }
    function Input({label, value, onChange, className=""}) { return (<div className={"grid gap-1 "+className}><label className="text-sm">{label}</label><input className="border rounded-xl p-2" value={value} onChange={e=>onChange(e.target.value)} /></div>); }
    function NumberInput({label, value, onChange, className=""}) { return (<div className={"grid gap-1 "+className}><label className="text-sm">{label}</label><input className="border rounded-xl p-2" type="number" value={value} onChange={e=>onChange(e.target.value)} /></div>); }
    function Textarea({label, value, onChange, className=""}) { return (<div className={"grid gap-1 "+className}><label className="text-sm">{label}</label><textarea className="border rounded-xl p-2" rows="3" value={value} onChange={e=>onChange(e.target.value)} /></div>); }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
